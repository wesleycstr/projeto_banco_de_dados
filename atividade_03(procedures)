/*PROCEDURE PARA CONSULTAR DISPONIBILIDADE DE CHAMADA*/

DELIMITER //

DROP PROCEDURE IF EXISTS processachamada;//

CREATE PROCEDURE processachamada(
    IN container INT,
    IN acao INT,
    IN ipusr VARCHAR(40)
)
BEGIN
    DECLARE retorno INT DEFAULT 0;
    DECLARE mensagem VARCHAR(255) DEFAULT '';
    DECLARE turmachamada VARCHAR(50) DEFAULT '';
    DECLARE iniciochamada TIME DEFAULT NULL;
    DECLARE fimchamada TIME DEFAULT NULL;
    DECLARE fimtolerancia TIME DEFAULT NULL;
    DECLARE data_atual DATE;
    DECLARE hora_atual TIME;

    -- Obtém a data e hora atuais
    SET data_atual = CURDATE();
    SET hora_atual = CURTIME();

    -- Verifica a ação solicitada
    IF acao = 0 THEN
        -- Consulta se há aula na data e horário atual
        IF EXISTS (
            SELECT 1
            FROM aulas a
            JOIN horarios h ON a.idhorario = h.idhorario
            WHERE a.data = data_atual
              AND h.horainicio <= hora_atual
              AND h.horafim >= hora_atual
        ) THEN
            -- Verifica se o aluno está matriculado no diário
            IF EXISTS (
                SELECT 1
                FROM aulas a
                JOIN matricula m ON a.iddiario = m.iddiario
                WHERE m.container = container
                  AND a.data = data_atual
            ) THEN
                -- Obtem informações da aula e horário
                SELECT a.iddiario, h.horainicio, h.horafim, ADDTIME(h.horafim, '00:15:00')
                INTO turmachamada, iniciochamada, fimchamada, fimtolerancia
                FROM aulas a
                JOIN horarios h ON a.idhorario = h.idhorario
                WHERE a.data = data_atual
                  AND h.horainicio <= hora_atual
                  AND h.horafim >= hora_atual
                LIMIT 1;

                -- Verifica se é marcação de entrada ou saída
                SELECT CASE
                           WHEN EXISTS (
                               SELECT 1
                               FROM aulas a
                               JOIN horarios h ON a.idhorario = h.idhorario
                               WHERE a.data = data_atual
                                 AND h.horainicio <= hora_atual
                                 AND h.horafim >= hora_atual
                                 AND h.horainicio <= hora_atual
                           ) THEN 1 -- Marcação de entrada disponível
                           WHEN EXISTS (
                               SELECT 1
                               FROM aulas a
                               JOIN horarios h ON a.idhorario = h.idhorario
                               WHERE a.data = data_atual
                                 AND h.horafim >= hora_atual
                                 AND h.horainicio <= hora_atual
                           ) THEN 2 -- Marcação de saída disponível
                           ELSE 0 -- Demais casos
                       END INTO retorno;

                -- Define a mensagem explicativa
                SET mensagem = CASE
                                   WHEN retorno = 1 THEN 'Marcação de entrada disponível.'
                                   WHEN retorno = 2 THEN 'Marcação de saída disponível.'
                                   ELSE 'Horário fora do período de marcação.'
                               END;
            ELSE
                SET retorno = 0; -- Aluno não está matriculado no diário
                SET mensagem = 'Aluno não está matriculado no diário.';
            END IF;
        ELSE
            SET retorno = 0; -- Nenhuma aula no horário atual
            SET mensagem = 'Nenhuma aula no horário atual.';
        END IF;

        -- Retorna o resultado
        SELECT retorno, mensagem, turmachamada AS turma, iniciochamada AS inicio, fimchamada AS fim, fimtolerancia AS tolerancia;
    END IF;

/*PROCEDURE PARA REGISTRAR ENTRADA*/
DELIMITER $$

USE `BD085`$$

DROP PROCEDURE IF EXISTS `registrarChamada`$$

CREATE PROCEDURE RegistrarChamada(
    IN container INT,
    IN acao INT,
    IN ipusr VARCHAR(40)
)
BEGIN
    DECLARE retorno INT DEFAULT 0;
    DECLARE mensagem TEXT;
    DECLARE iddiario INT;
    DECLARE idaluno INT;
    DECLARE idaula INT;
    DECLARE data_atual DATE;
    DECLARE hora_atual TIME;

    -- Obter a data e hora atual
    SET data_atual = CURDATE();
    SET hora_atual = CURTIME();

    -- Verificar se a ação é 1
    IF acao = 1 THEN
        -- Buscar idaluno e iddiario na tabela matricula
        SELECT m.idaluno, m.iddiario
        INTO idaluno, iddiario
        FROM matricula m
        WHERE m.container = container AND m.alunoativo = 1
        LIMIT 1;

        -- Verificar se encontrou registros
        IF idaluno IS NOT NULL AND iddiario IS NOT NULL THEN
            -- Buscar idaula na tabela aulas
            SELECT a.idaula
            INTO idaula
            FROM aulas a
            WHERE a.iddiario = iddiario AND a.data = data_atual
            LIMIT 1;

            -- Verificar se encontrou a aula
            IF idaula IS NOT NULL THEN
                -- Inserir na tabela chamada
                INSERT INTO chamada (idaula, iddiario, DATA, idaluno, marcacaoentrada, ip)
                VALUES (idaula, iddiario, data_atual, idaluno, hora_atual, ipusr);

                -- Ajustar retorno e mensagem
                SET retorno = 1;
                SET mensagem = 'Marcação de entrada realizada com sucesso.';
            ELSE
                -- Aula não encontrada
                SET mensagem = 'Erro: Aula não encontrada para o diário no dia atual.';
            END IF;
        ELSE
            -- Matrícula não encontrada
            SET mensagem = 'Erro: Matrícula ativa não encontrada para o container informado.';
        END IF;
    ELSE
        -- Ação inválida
        SET mensagem = 'Erro: Ação inválida. Apenas ação 1 é suportada.';
    END IF;

    -- Retornar resultado
    SELECT retorno AS retorno, mensagem AS mensagem;
END $$

DELIMITER ;

DELIMITER ;
END //

DELIMITER ;

